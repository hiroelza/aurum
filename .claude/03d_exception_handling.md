# 例外処理ルール

このファイルは、作業中に予期しない状況が発生した際の対応方法を定義します。

---

## Level判定の変更

作業中に複雑度（Level 1-4）の判定が変わった場合の対応フローです。

### 状況1: 現在のLevel < 新判定Level（複雑度が上昇）

**例**: Level 2（簡単）と思って始めたが、実際にはLevel 4（複雑）だった

**対応フロー:**

1. **即座に作業を中断**
   - 現在の進捗状況をメモ
   - TodoWriteツールの内容を一時保存

2. **不足しているドキュメントを作成**
   - Level 3になった場合:
     - `要件定義_[タスク名].md`を作成
     - `TODO_[タスク名].md`を作成
   - Level 4になった場合:
     - `要件定義_[タスク名].md`を作成
     - `要件詳細_[タスク名].md`を作成
     - `TODO_[タスク名].md`を作成

3. **ディレクトリ構成を修正**
   - 正しい配置先: `outputs/reports/working/yyyymm/yyyymmdd_テーマ/`
   - 既存のファイルがあれば移動

4. **作業を再開**
   - 新しいTODOリストに従って実行
   - 進捗状況を反映

**判定基準の再確認:**

| Level | 作業難度 | 所要時間 | ドキュメント要件 |
|-------|---------|---------|---------------|
| 1 | 極めて簡単 | 5分以内 | なし |
| 2 | 簡単 | 30分以内 | Plan Modeのみ |
| 3 | 中程度 | 1-2時間 | 要件定義+TODO |
| 4 | 複雑 | 2時間以上 | 要件定義+詳細+TODO |

### 状況2: 現在のLevel > 新判定Level（複雑度が低下）

**例**: Level 4（複雑）と思って準備したが、実際にはLevel 2（簡単）だった

**対応フロー:**

1. **そのまま継続**
   - 既に作成したドキュメントは削除しない
   - 過剰準備は問題ではない

2. **ファイルは残す**
   - `要件定義_[タスク名].md`
   - `要件詳細_[タスク名].md`
   - `TODO_[タスク名].md`
   - **理由**: トレーサビリティの確保、将来の参考資料

3. **次回以降の改善**
   - Level判定の精度を上げる
   - `.claude/03a_work_levels.md`を再確認

---

## ファイル配置ミスの対応

### 間違った場所にファイルを作成してしまった場合

**状況例:**
- `outputs/reports/working/20251109_テーマ/`を作成（月ディレクトリ欠落）
- 正しくは: `outputs/reports/working/202511/20251109_テーマ/`

**対応フロー:**

1. **即座に修正**
   ```bash
   # 正しいディレクトリ構造を作成
   mkdir -p outputs/reports/working/202511/

   # ファイルを移動
   mv outputs/reports/working/20251109_テーマ/ outputs/reports/working/202511/
   ```

2. **チェックリストを再確認**
   - `.claude/00_work_checklist.md`を開く
   - 「新規ファイル作成時の確認事項」セクションを再読
   - `.claude/02_directory_structure.md`を再確認

3. **再発防止**
   - 次回作業時は必ずチェックリストを確認
   - 「記憶」ではなく「ドキュメント」に従う

---

## Python実行エラーの対応

### カレントディレクトリ起因のエラー

**状況**: `python/controllers/xxx.py`を実行したが、モジュールが見つからない

**対応フロー:**

1. **カレントディレクトリを確認**
   ```bash
   pwd
   ```

2. **`aurum/`に移動**
   ```bash
   cd C:/Users/DaisukeDeskTop/projects/aurum
   ```

3. **再実行**
   ```bash
   python python/controllers/xxx.py
   ```

4. **ルール確認**
   - `.claude/04_python_guide.md`を再読
   - 実行起点ルールの徹底

### モジュール不足エラー

**状況**: `ModuleNotFoundError`が発生

**対応フロー:**

1. **requirements.txtを確認**
   ```bash
   cat requirements.txt
   ```

2. **不足ライブラリをインストール**
   ```bash
   pip install -r requirements.txt
   ```

3. **再実行**

---

## 投資判断中の方針変更

### 3エージェント評価の途中で判断が変わった場合

**状況**: Phase 2（発散）で当初の方針が不適切だと判明

**対応フロー:**

1. **Phase 1に戻る**
   - 議論ファイル`議論_[テーマ]_phase1_共有.md`を再確認
   - 前提条件を見直す

2. **新しい方針で再評価**
   - Phase 2を再実行
   - Phase 3、Phase 4と進める

3. **旧評価ファイルは削除せず保管**
   - ファイル名に`_旧`を追加
   - 例: `議論_[テーマ]_phase2_発散_旧.md`
   - **理由**: 判断プロセスのトレーサビリティ

---

## セッション強制終了時の対応

### Claude Codeが予期せず終了した場合

**状況**: ブラウザクラッシュ、ネットワーク切断等

**対応フロー:**

1. **TodoWriteツールの内容は消失**
   - セッション中の進捗情報は復元不可

2. **ファイルベースの復旧**
   - `outputs/reports/working/`配下の最新ディレクトリを確認
   - `TODO_*.md`の最終状態を確認
   - 前回の`[x]`マークから再開

3. **再開チェックリスト**
   - `.claude/00_work_checklist.md`の「セッション再開時の確認事項」を実行

---

## ルール解釈の不明点

### ドキュメント間で矛盾がある場合

**優先順位:**

1. **プロジェクト固有ルール**（`.claude/CLAUDE.md`）
2. **作業チェックリスト**（`.claude/00_work_checklist.md`）
3. **個別ドキュメント**（`.claude/01-10*.md`）
4. **グローバル設定**（`~/CLAUDE.md`）

**対応フロー:**

1. **優先順位に従って判断**
2. **不明点はユーザーに質問**
   - `AskUserQuestion`ツールを使用
   - 曖昧さを残さない
3. **判断結果をドキュメント化**
   - 該当ファイルに注記追加
   - 更新履歴に記録

---

## Git操作のトラブル

### 機密ファイルをステージングしてしまった場合

**状況**: `git add .`で誤って機密ファイルを追加

**対応フロー:**

1. **即座にunstage**
   ```bash
   git reset HEAD python/config/personal.py
   git reset HEAD INVESTMENT_PROFILE.md
   ```

2. **.gitignoreを再確認**
   ```bash
   cat .gitignore
   ```

3. **機密ファイルリストを確認**
   - `.claude/CLAUDE.md`の「機密情報管理」セクション
   - 対象ファイル一覧を再確認

4. **再発防止**
   - `git status`で必ず確認してからcommit
   - 機密ファイルが含まれていないことを確認

---

## 不明な状況への対応

### 本ドキュメントで対応方法が見つからない場合

**対応フロー:**

1. **関連ドキュメントを検索**
   - `.claude/`配下のすべてのMarkdownファイル
   - `README.md`、`CLAUDE.md`

2. **ユーザーに質問**
   - `AskUserQuestion`ツールで明確化
   - 曖昧さを残さない

3. **判断結果を記録**
   - 該当する設定ファイルに追記
   - 本ファイル（`03d_exception_handling.md`）に新規セクション追加

---

## 更新履歴

### 2025年11月11日（初版）
- 例外処理ルールの策定
- Level判定変更、ファイル配置ミス、Python実行エラー等の対応フロー定義
- セッション強制終了時の復旧手順を明記

---

**作成日**: 2025年11月11日
**最終更新**: 2025年11月11日
