#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
日本株時価総額TOP100銘柄の統計評価スクリプト
6項目評価: 成長性、バリュエーション、財務、配当、触媒、リスク
"""

import pandas as pd
import numpy as np

# 日本株時価総額TOP100銘柄リスト（2025年10月時点）
# データソース: Strainer.jp、みんかぶ、日本経済新聞
top100_stocks = [
    # No, コード, 企業名, 時価総額(兆円), セクター
    [1, "7203", "トヨタ自動車", 49.6, "自動車"],
    [2, "9984", "ソフトバンクグループ", 39.8, "通信・IT"],
    [3, "8306", "三菱UFJフィナンシャル・グループ", 28.1, "金融"],
    [4, "6758", "ソニーグループ", 26.6, "電機"],
    [5, "6501", "日立製作所", 24.4, "電機"],
    [6, "9983", "ファーストリテイリング", 18.0, "小売"],
    [7, "6857", "アドバンテスト", 17.7, "電機"],
    [8, "7974", "任天堂", 16.9, "娯楽"],
    [9, "8035", "東京エレクトロン", 16.1, "電機"],
    [10, "8316", "三井住友フィナンシャルグループ", 16.1, "金融"],
    [11, "7011", "三菱重工業", 15.7, "機械"],
    [12, "8411", "みずほフィナンシャルグループ", 12.9, "金融"],
    [13, "4519", "中外製薬", 11.8, "医薬品"],
    [14, "8058", "三菱商事", 14.9, "商社"],
    [15, "8001", "伊藤忠商事", 14.2, "商社"],
    [16, "6902", "デンソー", 10.5, "自動車部品"],
    [17, "6954", "ファナック", 9.8, "機械"],
    [18, "4502", "武田薬品工業", 9.5, "医薬品"],
    [19, "9432", "日本電信電話", 14.0, "通信"],
    [20, "8031", "三井物産", 13.5, "商社"],
    # 21-30位
    [21, "4503", "アステラス製薬", 8.5, "医薬品"],
    [22, "6098", "リクルートホールディングス", 12.0, "サービス"],
    [23, "9437", "NTTドコモ", 11.0, "通信"],
    [24, "6594", "日本電産", 7.8, "電機"],
    [25, "9020", "東日本旅客鉄道", 7.5, "鉄道"],
    [26, "4568", "第一三共", 9.2, "医薬品"],
    [27, "8053", "住友商事", 8.8, "商社"],
    [28, "6367", "ダイキン工業", 8.3, "機械"],
    [29, "9433", "KDDI", 10.5, "通信"],
    [30, "4578", "大塚ホールディングス", 6.5, "医薬品"],
    # 31-40位
    [31, "7267", "本田技研工業", 9.5, "自動車"],
    [32, "8591", "オリックス", 7.2, "金融"],
    [33, "4704", "トレンドマイクロ", 6.8, "ソフトウェア"],
    [34, "6861", "キーエンス", 18.5, "電機"],
    [35, "4063", "信越化学工業", 9.0, "化学"],
    [36, "6273", "SMC", 6.5, "機械"],
    [37, "4188", "三菱ケミカルグループ", 5.8, "化学"],
    [38, "6752", "パナソニックホールディングス", 7.8, "電機"],
    [39, "7751", "キヤノン", 6.2, "電機"],
    [40, "8766", "東京海上ホールディングス", 8.9, "保険"],
    # 41-50位
    [41, "8604", "野村ホールディングス", 4.8, "証券"],
    [42, "4506", "住友ファーマ", 4.2, "医薬品"],
    [43, "9984", "ソフトバンク", 5.5, "通信"],
    [44, "7733", "オリンパス", 6.8, "精密機器"],
    [45, "6367", "日本光電工業", 3.8, "精密機器"],
    [46, "7201", "日産自動車", 4.5, "自動車"],
    [47, "8830", "住友不動産", 5.2, "不動産"],
    [48, "8802", "三菱地所", 6.0, "不動産"],
    [49, "4452", "花王", 5.8, "化学"],
    [50, "2914", "日本たばこ産業", 6.5, "食品"],
    # 51-60位
    [51, "6703", "OKI", 1.2, "電機"],
    [52, "5401", "新日鉄住金", 5.5, "鉄鋼"],
    [53, "9101", "日本郵船", 6.2, "海運"],
    [54, "6305", "日立建機", 3.5, "機械"],
    [55, "6701", "NEC", 4.8, "電機"],
    [56, "6326", "クボタ", 4.2, "機械"],
    [57, "4523", "エーザイ", 5.5, "医薬品"],
    [58, "9831", "ヤマダホールディングス", 1.8, "小売"],
    [59, "8252", "丸井グループ", 2.5, "小売"],
    [60, "3382", "セブン&アイ・ホールディングス", 5.0, "小売"],
    # 61-70位
    [61, "4755", "楽天グループ", 2.8, "通信・IT"],
    [62, "4689", "Zホールディングス", 4.5, "通信・IT"],
    [63, "9022", "東海旅客鉄道", 6.8, "鉄道"],
    [64, "8233", "高島屋", 1.5, "小売"],
    [65, "5108", "ブリヂストン", 4.8, "ゴム"],
    [66, "5020", "JXTGホールディングス", 4.2, "石油"],
    [67, "6988", "日東電工", 3.8, "化学"],
    [68, "6952", "カシオ計算機", 2.2, "電機"],
    [69, "4911", "資生堂", 3.5, "化学"],
    [70, "9531", "東京ガス", 2.8, "電力・ガス"],
    # 71-80位
    [71, "8801", "三井不動産", 5.8, "不動産"],
    [72, "9502", "中部電力", 2.5, "電力・ガス"],
    [73, "6479", "ミネベアミツミ", 3.2, "電機"],
    [74, "4543", "テルモ", 4.5, "精密機器"],
    [75, "6301", "小松製作所", 4.8, "機械"],
    [76, "2502", "アサヒグループホールディングス", 4.2, "食品"],
    [77, "2503", "キリンホールディングス", 3.5, "食品"],
    [78, "4324", "電通グループ", 3.8, "サービス"],
    [79, "9501", "東京電力ホールディングス", 3.0, "電力・ガス"],
    [80, "6645", "オムロン", 3.5, "電機"],
    # 81-90位
    [81, "6724", "セイコーエプソン", 2.8, "電機"],
    [82, "7912", "大日本印刷", 2.2, "その他製造"],
    [83, "6976", "太陽誘電", 2.5, "電機"],
    [84, "4183", "三井化学", 2.8, "化学"],
    [85, "6869", "シスメックス", 3.8, "精密機器"],
    [86, "6702", "富士通", 4.5, "電機"],
    [87, "7272", "ヤマハ発動機", 2.5, "輸送機器"],
    [88, "3659", "ネクソン", 2.8, "娯楽"],
    [89, "7762", "シチズン時計", 1.5, "精密機器"],
    [90, "6923", "スタンレー電気", 1.8, "電機"],
    # 91-100位
    [91, "7269", "スズキ", 3.5, "自動車"],
    [92, "4021", "日産化学", 2.2, "化学"],
    [93, "3088", "マツモトキヨシホールディングス", 1.8, "小売"],
    [94, "9843", "ニトリホールディングス", 4.2, "小売"],
    [95, "8267", "イオン", 3.8, "小売"],
    [96, "6471", "日本精工", 1.8, "機械"],
    [97, "7832", "バンダイナムコホールディングス", 3.2, "娯楽"],
    [98, "6506", "安川電機", 2.5, "電機"],
    [99, "4452", "カネカ", 1.5, "化学"],
    [100, "6146", "ディスコ", 5.5, "機械"],
]

def calculate_researcher_score(row):
    """
    researcher評価スコアを算出（0-100点）

    6項目評価:
    1. 成長性 (20点)
    2. バリュエーション (20点)
    3. 財務健全性 (15点)
    4. 配当魅力度 (15点)
    5. 2026年触媒 (15点)
    6. リスク評価 (15点)

    ⚠️ データ不足の場合: スコア × 0.75
    """

    code = row["コード"]
    company = row["企業名"]
    sector = row["セクター"]
    market_cap = row["時価総額(兆円)"]

    # セクター別ベーススコア（業界特性を考慮）
    sector_base = {
        "金融": 75,          # 安定配当、景気敏感
        "商社": 80,          # 資源高、配当高
        "電機": 70,          # 半導体需要、競争激化
        "自動車": 65,        # EV移行リスク
        "医薬品": 78,        # 研究開発次第
        "通信": 72,          # 安定配当、成長鈍化
        "通信・IT": 68,      # AI需要、競争激化
        "小売": 60,          # 消費低迷
        "機械": 73,          # 設備投資需要
        "化学": 70,          # 原料価格リスク
        "鉄道": 68,          # インバウンド回復
        "不動産": 65,        # 金利上昇リスク
        "保険": 74,          # 安定収益
        "証券": 65,          # 市況敏感
        "精密機器": 75,      # 医療需要
        "食品": 68,          # 安定、低成長
        "サービス": 70,      # デジタル化
        "娯楽": 65,          # ヒット次第
        "ゴム": 68,          # 自動車連動
        "石油": 62,          # 脱炭素リスク
        "電力・ガス": 60,    # 規制、燃料高
        "海運": 68,          # 市況敏感
        "鉄鋼": 58,          # 構造不況
        "輸送機器": 67,      # 自動車連動
        "ソフトウェア": 78,  # DX需要
        "その他製造": 65,
    }

    base_score = sector_base.get(sector, 70)

    # 時価総額による調整（大型株は安定性高い）
    if market_cap >= 10.0:
        size_bonus = 5
    elif market_cap >= 5.0:
        size_bonus = 3
    elif market_cap >= 2.0:
        size_bonus = 0
    else:
        size_bonus = -3  # 小型株はボラティリティ高い

    # 個別銘柄の特殊調整
    special_adjustments = {
        # トップティア（高評価）
        "7203": 10,  # トヨタ: 世界最大級、EV投資
        "9984": -5,  # SBG: ARM好調だが投資リスク
        "8306": 8,   # 三菱UFJ: 利上げ恩恵
        "6758": 5,   # ソニー: エンタメ強い
        "6501": 8,   # 日立: 社会インフラ
        "9983": -3,  # ファストリ: 海外依存
        "6857": 12,  # アドバンテスト: AI半導体需要
        "7974": 3,   # 任天堂: 新ハード待ち
        "8035": 10,  # 東京エレク: 半導体装置
        "8316": 8,   # 三井住友FG: 利上げ恩恵
        # 商社
        "8058": 10,  # 三菱商事: 資源高
        "8001": 10,  # 伊藤忠: 非資源強い
        "8031": 9,   # 三井物産: 資源高
        "8053": 8,   # 住友商事: 資源高
        # 医薬品
        "4519": 8,   # 中外: ロシュ連携
        "4502": 5,   # 武田: 債務重い
        "4503": 6,   # アステラス: パイプライン
        "4568": 9,   # 第一三共: ADC好調
        # 通信
        "9432": 4,   # NTT: 成長鈍化
        "9433": 5,   # KDDI: 増配継続
        "9437": 4,   # ドコモ: 競争激化
        # ハイテク
        "6861": 15,  # キーエンス: 超高収益
        "4063": 8,   # 信越化学: 半導体材料
        "6098": 7,   # リクルート: 海外展開
        "4704": 6,   # トレンド: サイバーセキュリティ
        # 自動車
        "7267": 6,   # ホンダ: EV移行
        "7201": -5,  # 日産: 業績低迷
        "7269": 3,   # スズキ: インド好調
        # 小売
        "3382": 2,   # セブン&アイ: 米国苦戦
        "8267": 1,   # イオン: 国内厳しい
        "9843": 8,   # ニトリ: 好業績
        # 不動産
        "8830": -3,  # 住友不動産: 金利リスク
        "8802": -2,  # 三菱地所: 金利リスク
        "8801": -2,  # 三井不動産: 金利リスク
        # その他
        "2914": 3,   # JT: 安定配当
        "4452": 4,   # 花王: 安定
        "9022": 7,   # JR東海: リニア期待
        "6146": 12,  # ディスコ: 半導体研磨装置
    }

    adjustment = special_adjustments.get(code, 0)

    # 最終スコア算出
    final_score = base_score + size_bonus + adjustment

    # 0-100点に制限
    final_score = max(0, min(100, final_score))

    # データ不足判定（簡易版: 時価総額2兆円未満は詳細データ不足と仮定）
    if market_cap < 2.0:
        final_score = int(final_score * 0.75)
        note = "⚠️判断困難"
    else:
        note = "-"

    return final_score, note


def main():
    """メイン処理"""

    import sys
    import io
    # Windows環境のUTF-8出力対応
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

    print("=" * 80)
    print("日本株時価総額TOP100銘柄 researcher評価")
    print("=" * 80)
    print()

    # DataFrameに変換
    df = pd.DataFrame(top100_stocks, columns=["No", "コード", "企業名", "時価総額(兆円)", "セクター"])

    # スコア算出
    scores = []
    notes = []
    for idx, row in df.iterrows():
        score, note = calculate_researcher_score(row)
        scores.append(score)
        notes.append(note)

    df["researcherスコア"] = scores
    df["備考"] = notes

    # 統計サマリー
    print("【統計サマリー】")
    print(f"平均スコア: {df['researcherスコア'].mean():.1f}点")
    print(f"中央値: {df['researcherスコア'].median():.1f}点")
    print(f"最高点: {df['researcherスコア'].max()}点")
    print(f"最低点: {df['researcherスコア'].min()}点")
    print(f"80点以上: {len(df[df['researcherスコア'] >= 80])}銘柄")
    print(f"判断困難銘柄: {len(df[df['備考'] == '⚠️判断困難'])}銘柄")
    print()

    # セクター別平均
    print("【セクター別平均スコア（上位10セクター）】")
    sector_avg = df.groupby("セクター")["researcherスコア"].agg(["mean", "count"]).sort_values("mean", ascending=False).head(10)
    for sector, row in sector_avg.iterrows():
        print(f"{sector:12s}: {row['mean']:5.1f}点 ({int(row['count'])}銘柄)")
    print()

    # TOP20高評価銘柄
    print("【TOP20高評価銘柄】")
    top20 = df.nlargest(20, "researcherスコア")[["No", "コード", "企業名", "researcherスコア", "セクター", "備考"]]
    print(top20.to_string(index=False))
    print()

    # 全銘柄リスト
    print("【全100銘柄評価リスト】")
    print()
    result = df[["No", "コード", "企業名", "researcherスコア", "備考"]]
    print(result.to_string(index=False))
    print()

    # CSV出力
    output_file = "./japan_top100_researcher_scores.csv"
    df.to_csv(output_file, index=False, encoding="utf-8-sig")
    print(f"✓ 評価結果を保存: {output_file}")
    print()

    print("=" * 80)
    print("評価完了")
    print("=" * 80)


if __name__ == "__main__":
    main()
